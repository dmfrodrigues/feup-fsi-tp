## Week 4 Logbook

## Seed Labs

### Task 1

```bash
[11/07/21]seed@VM:~/.../Labsetup$ printenv PWD
/home/seed/Share/seed-labs/category-software/Environment_Variable_and_SetUID/Labsetup
[11/07/21]seed@VM:~/.../Labsetup$ export MYVAR="Hello world!"
[11/07/21]seed@VM:~/.../Labsetup$ printenv MYVAR
Hello world!
[11/07/21]seed@VM:~/.../Labsetup$ unset MYVAR
[11/07/21]seed@VM:~/.../Labsetup$ printenv MYVAR
[11/07/21]seed@VM:~/.../Labsetup$ 
```

### Task 2

The code in `myprintenv.c` prints the list the environment variables of the child process, in a similar way to the `printenv` command (NAME=value). We use the redirection operator (`>`) to redirect `stdout` to `file1.txt`.

After changing the code as suggested in the lab notes and compiling, the environment variables of the parent are printed (or in this case, redirected to `file2.txt`).

```bash
[11/07/21]seed@VM:~/.../Labsetup$ diff file1.txt file2.txt 
[11/07/21]seed@VM:~/.../Labsetup$
```

Since the `diff` command shows that both files are the same, we can conclude that the environment variables of the parent process are inherited by the child process.

### Task 3

When compiling and running the program, we verify that the process generated by `execve` uses the environment variables specified in the third argument of the `execve` call. This is shown by the fact that passing `NULL` as the 3rd argument causes the new `env` process to print nothing, and passing `environ` causes the process to print all the environment variables in `environ`.

```bash
[11/07/21]seed@VM:~/.../Labsetup$ cat task3_file1.txt 
[11/07/21]seed@VM:~/.../Labsetup$ head task3_file2.txt
SHELL=/bin/bash
SESSION_MANAGER=local/VM:@/tmp/.ICE-unix/1925,unix/VM:/tmp/.ICE-unix/1925
QT_ACCESSIBILITY=1
COLORTERM=truecolor
XDG_CONFIG_DIRS=/etc/xdg/xdg-ubuntu:/etc/xdg
XDG_MENU_PREFIX=gnome-
GNOME_DESKTOP_SESSION_ID=this-is-deprecated
GNOME_SHELL_SESSION_MODE=ubuntu
SSH_AUTH_SOCK=/run/user/1000/keyring/ssh
XMODIFIERS=@im=ibus
[11/07/21]seed@VM:~/.../Labsetup$
```

### Task 4

As we can see, the environment variables of the calling process are passed to the program that is invoked using `system()`.

```bash
[11/07/21]seed@VM:~/.../Labsetup$ head task4.txt
LESSOPEN=| /usr/bin/lesspipe %s
USER=seed
SSH_AGENT_PID=1884
XDG_SESSION_TYPE=x11
SHLVL=1
HOME=/home/seed
OLDPWD=/home/seed/Share/seed-labs
DESKTOP_SESSION=ubuntu
GNOME_SHELL_SESSION_MODE=ubuntu
GTK_MODULES=gail:atk-bridge
[11/07/21]seed@VM:~/.../Labsetup$ 
```

### Task 5

```bash
[11/07/21]seed@VM:~/.../tp4$ gcc task5.c -o foo
[11/07/21]seed@VM:~/.../tp4$ ls -la
total 32
drwxrwxr-x 2 seed seed  4096 Nov  7 12:14 .
drwxrwxr-x 3 seed seed  4096 Nov  7 12:13 ..
-rwxrwxr-x 1 seed seed 16768 Nov  7 12:14 foo
-rw-rw-r-- 1 seed seed   182 Nov  7 12:14 task5.c
[11/07/21]seed@VM:~/.../tp4$ sudo chown root foo
[11/07/21]seed@VM:~/.../tp4$ sudo chmod 4755 foo
[11/07/21]seed@VM:~/.../tp4$ ls -la
total 32
drwxrwxr-x 2 seed seed  4096 Nov  7 12:14 .
drwxrwxr-x 3 seed seed  4096 Nov  7 12:13 ..
-rwsr-xr-x 1 root seed 16768 Nov  7 12:14 foo
-rw-rw-r-- 1 seed seed   182 Nov  7 12:14 task5.c
[11/07/21]seed@VM:~/.../tp4$ 
```

The owner of the `foo` file changed from `seed` to `root` and the file permission changed to `-rwsr-xr-x` (the setuid bit for the `root` user is set, to allow normal users to execute the file with the owner's privileges).

```bash
[11/07/21]seed@VM:~/.../tp4$ printenv | grep "LD_LIBRARY_PATH"
[11/07/21]seed@VM:~/.../tp4$ foo > file1.txt
[11/07/21]seed@VM:~/.../tp4$ export PATH="/bin"
[11/07/21]seed@VM:~/.../tp4$ export LD_LIBRARY_PATH="/bin"
[11/07/21]seed@VM:~/.../tp4$ export MYVAR="Hello world!"
[11/07/21]seed@VM:~/.../tp4$ ./foo > file2.txt
[11/07/21]seed@VM:~/.../tp4$ diff file1.txt file2.txt 
7a8
> MYVAR=Hello world!
43c44
< PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:.
---
> PATH=/bin
[11/07/21]seed@VM:~/.../tp4$ printenv | grep "LD_LIBRARY_PATH"
LD_LIBRARY_PATH=/bin
[11/07/21]seed@VM:~/.../tp4$ 
```

The `PATH` and `MYVAR` environment variables are passed to the Set-UID child process, but the `LD_LIBRARY_PATH` variable is not, despite appearing in the output of `printenv`. This indicates that some environment variables will be ignored by the dynamic linker when running a program owned by `root` with `setuid`. The `LD_LIBRARY_PATH` tells the dynamic linker where to look for the dynamic shared libraries that the program was linked against.


### Task 6

**run_ls.c**
```c
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>

int main(){
    printf("run_ls: geteuid=%d\n", geteuid());
    system("ls");
    return 0;
}
```

**ls.c**
```c
#include <stdio.h>
#include <unistd.h>

int main(){
    printf("ls: You have been hacked!\n");
    printf("ls: geteuid=%d\n", geteuid());
    return 0;
}
```

**Bash logs**

```bash
[11/07/21]seed@VM:~$ export PATH=/home/seed:$PATH
[11/07/21]seed@VM:~$ gcc run_ls.c -o run_ls
[11/07/21]seed@VM:~$ sudo chown root run_ls
[11/07/21]seed@VM:~$ sudo chmod 4755 run_ls
[11/07/21]seed@VM:~$ run_ls
run_ls: geteuid=0
Desktop    ls.c      Public    seed-labs  Videos
Documents  Music     run_ls    Share
Downloads  Pictures  run_ls.c  Templates
[11/07/21]seed@VM:~$ gcc ls.c -o ls
[11/07/21]seed@VM:~$ run_ls
run_ls: geteuid=0
ls: You have been hacked!
ls: geteuid=1000
[11/07/21]seed@VM:~$ sudo ln -sf /bin/zsh /bin/sh
[11/07/21]seed@VM:~$ run_ls
run_ls: geteuid=0
ls: You have been hacked!
ls: geteuid=0
[11/07/21]seed@VM:~$ 
```

The `geteuid` C function is used to obtain the effective user ID for that process, which can be used to assess its privileges. If this function returns 0, the process is running with `root` privileges.

As we can see, after changing the `PATH` environment variable, our own malicious `ls` program in `/home/seed` takes precedence over the `ls` command in `/usr/bin` and executes.

However, as mentioned in the lab notes, the `system` function asks the `/bin/sh` program to run the `ls` command. Since in the SEED VM `/bin/sh` is a symbolic link to `/bin/dash`, a countermeasure in this shell program prevents our `ls` program from obtaining root privileges (the effective UID is 1000). Only the original `run_ls` program has root privileges in this case.

After we run the `sudo ln -sf /bin/zsh /bin/sh` command, this countermeasure is no longer in place, and our malicious `ls` program obtains root privileges (`geteuid=0`).

---

## CTF

### Recon

- **Wordpress (v5.8.1)** (most recent version, from 2021-09-08)
- **Plugins**
    - Storefront (v3.9.1)
    - WooCommerce (v5.7.1)
        - `add-to-cart`
        - `cart-fragments`
    - Booster for WooCommerce (5.4.3)
- **Possible User Information**
    - admin
        - links to `localhost:8000`
    - Orval Sanford
        - link to user (`author/orval_sanford`) redirects to shop page
        - username: `orval_sanford`

### Searching for Vulnerabilities

Searching for WooCommerce Booster on Exploit-DB / NVD lead us to [CVE-2021-34646](https://nvd.nist.gov/vuln/detail/CVE-2021-34646).

### Looking for Exploits

The ExploitDB page for the previously described vulnerability includes a [Python exploit](https://www.exploit-db.com/exploits/50299).

### Exploiting the Vulnerability

```sh
python3 exploit.py http://ctf-fsi.fe.up.pt:5001/my-account/ 1
```
